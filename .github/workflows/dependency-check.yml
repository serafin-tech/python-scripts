name: Dependency Check

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

jobs:
  check-dependencies:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Check for outdated dependencies
        id: check-outdated
        run: |
          echo "## Outdated Dependencies Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Current installed versions:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pip list >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Outdated packages:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pip list --outdated || true >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Store outdated count for later use
          OUTDATED_COUNT=$(pip list --outdated --format=json | python -c "import sys, json; print(len(json.load(sys.stdin)))")
          echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT

          if [ $OUTDATED_COUNT -gt 0 ]; then
            echo "⚠️ Found $OUTDATED_COUNT outdated package(s)" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ All packages are up to date!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check with pip-check-updates
        run: |
          echo "### pip-check-updates analysis:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pcu pyproject.toml || true >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Comment on outdated dependencies
        if: steps.check-outdated.outputs.outdated_count > 0
        run: |
          echo "::notice::Found ${{ steps.check-outdated.outputs.outdated_count }} outdated package(s). Check the job summary for details."
